{"componentChunkName":"component---src-pages-install-data-index-mdx","path":"/install/data/","result":{"pageContext":{"frontmatter":{"title":"Install Cloud Pak for Data 3.0.1 on IBM Managed Openshift 4.3 (ROKS)"},"relativePagePath":"/install/data/index.mdx","titleType":"page","MdxNode":{"id":"70d6762f-5276-5dc5-b841-c265c5df5262","children":[],"parent":"ba327581-788d-5d8b-97c9-e7e2cbe81085","internal":{"content":"---\ntitle: Install Cloud Pak for Data 3.0.1 on IBM Managed Openshift 4.3 (ROKS)\n---\n\nimport Globals from 'gatsby-theme-carbon/src/templates/Globals';\n\n<PageDescription>\n\n</PageDescription>\n\n## Install Cloud Pak for Data 3.0.1 on IBM Managed Openshift 4.3 (ROKS)\n\n### Sizing Openshift Cluster for Cloud Pak for Data 3.0.1\n\nSizing Worker Nodes based on Services that are to be installed. Refer : https://salesconfig.ibmcloudpack.com/sales/#/zen/configure\nTo do the sizing\n\nPlease note that if you want to install Watson AI services (Watson Assistant, Watson Discovery, Watson AIOps, Watson Language Translator, Watson Speech to Text, Watson Text to Speech) size them separately as they will need bare metal worker nodes and will not work on virtual server worker nodes.\n\n### Provision Openshift 4.3 Cluster on IBM Cloud\n\n**Note:** Make sure you have Administrator and Manager lever permission on the account where you are provisioning the cluster.\n\nProvision Openshift 4.3 Cluster from IBM Cloud console. Select Virtual Server Worker nodes based on the above sizing calculations. If you are installing Watson AI services, we will add Bare metal worker nodes post the cluster creation.\n\nOnce the cluster is created, create a new worker pool which will have bare metal servers required for Watson AI Services installation.\n\n\n\nOnce the cluster is ready, launch its console and on the right top corner, from copy login command, get the token to login to Openshift cluster remotely using cli\n \n\nMake sure you have a system with Openshift and IBM Cloud cli installed.\nhttps://cloud.ibm.com/docs/openshift?topic=openshift-openshift-cli#cli_oc\nhttps://cloud.ibm.com/docs/cli/reference/bluemix_cli/download_cli.html\n\nExecute oc login command obtained in above step from Openshift Web Console\n\n### Setting up Openshift Cluster for Cloud Pak for Data Installation\n\n1.\tCreate an external route of Openshift Image registry.\nUse token obtained in abive step to login from a system to OpenShift Cluster and run below commands to create an external route\n\n```\noc create route reencrypt --service=image-registry -n openshift-image-registry\noc annotate route image-registry --overwrite haproxy.router.openshift.io/balance=source -n openshift-image-registry\n```\n\n2.\tResize image registry storage volume\nDefault size of Openshift image registry will not be sufficient to load images if you are going to install multiple Services on Cloud Pak for Data. Hence it needs to be resized to 200GB. Run below commands to do it.\n\nibmcloud login (login into Account where your Openshift Cluster is setup)\n```\nregistry_pv=`oc get pvc -n openshift-image-registry | grep \"image-registry-storage\" | awk '{print $3}'`\nvolid=`oc describe pv $registry_pv -n openshift-image-registry | grep volumeId`\nIFS='='\nread -ra vol <<< \"$volid\"\nvolume=${vol[1]}\necho volume id is $volume\nibmcloud sl file volume-modify $volume --new-size 200 --new-tier 10 â€“force\n```\n\n3.\tSet kernel parameters (https://www.ibm.com/support/knowledgecenter/SSQNUZ_3.0.1/cpd/install/node-settings.html)\nSince we do not have ssh access to worker nodes on ROKS, we will use daemonset to perform kernel parameter settings. Create setkernelparameters.yaml file with below contents\n\n```apiVersion: tuned.openshift.io/v1\nkind: Tuned\nmetadata:\n  name: cp4d-wkc-ipc\n  namespace: openshift-cluster-node-tuning-operator\nspec:\n  profile:\n  - name: cp4d-wkc-ipc\n    data: |\n      [main]\n      summary=Tune IPC Kernel parameters on OpenShift Worker Nodes running WKC Pods\n      [sysctl]\n      kernel.shmall = 33554432\n      kernel.shmmax = 68719476736\n      kernel.shmmni = 16384\n      kernel.sem = 250 1024000 100 16384\n      kernel.msgmax = 65536\n      kernel.msgmnb = 65536\n      kernel.msgmni = 32768\n      vm.max_map_count = 262144\n  recommend:\n  - match:\n    - label: node-role.kubernetes.io/worker\n    priority: 10\n    profile: cp4d-wkc-ipc\n```\n\nRun below commands to do the changes\n\n```\noc project kube-system\noc create -f setkernelparameters.yaml\n```\n\n4.\tChange NFS mount settings\nIf you are using IBM Cloud File Storage for PVC creation, we need to make sure pvcs are mounted with root permissions. \n\na.\tCreate a service account called norootsquash by running the following command:\n\n```\noc create -f - << EOF\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: norootsquash\n  namespace: kube-system\nEOF\n```\n\nb.\tGive the service account privileged security context constraints (SCC) by running the following command:\n\n``` \noc adm policy add-scc-to-user privileged system:serviceaccount:kube-system:norootsquash\n```\n\nc.\tCreate the daemonset by running the following command:\n\n```\noc create -f - << EOF\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: norootsquash\n  namespace: kube-system\n  labels:\n    tier: management\n    app: norootsquash\nspec:\n  selector:\n    matchLabels:\n      name: norootsquash\n  template:\n    metadata:\n      labels:\n        name: norootsquash\n    spec:\n      serviceAccountName: norootsquash\n      initContainers:\n        - resources:\n            requests:\n              cpu: 0.1\n          securityContext:\n            privileged: true\n          image: alpine:3.6\n          name: unrootsquash\n          command: [\"chroot\", \"/host\", \"sh\", \"-c\"]\n          args:\n            - >\n              grep \"^Domain = slnfsv4.com\" /etc/idmapd.conf;\n              if [ \"\\$?\" -ne \"0\" ] ; then\n                sed -i 's/.*Domain =.*/Domain = slnfsv4.com/g' /etc/idmapd.conf;\n                nfsidmap -c;\n                rpc.idmapd\n              fi;\n          volumeMounts:\n            - name: host\n              mountPath: /host\n      containers:\n        - resources:\n            requests:\n              cpu: 0.1\n          image: alpine:3.6\n          name: sleep\n          command: [\"/bin/sh\", \"-c\"]\n          args:\n            - >\n              while true; do\n                sleep 100000;\n              done\n      volumes:\n        - hostPath:\n            path: /\n            type: Directory\n          name: host\nEOF\n```\n\n### Setting Portworx Storage\n\nWatson AI services (Watson Assistant, Watson Discovery, Watson Knowledge Studio, Watson Speech to Text and Watson text to Speech) install is currently supported only with Enterprise Portworx storage. Follow the steps mentioned below to set that up for ROKS. Make sure you are logged in to IBM Cloud and Openshift using CLI (ibmcloud and oc)\n\n \n\n","type":"Mdx","contentDigest":"5fb5e723db83f17b6732f69c572e4131","counter":441,"owner":"gatsby-plugin-mdx"},"frontmatter":{"title":"Install Cloud Pak for Data 3.0.1 on IBM Managed Openshift 4.3 (ROKS)"},"exports":{},"rawBody":"---\ntitle: Install Cloud Pak for Data 3.0.1 on IBM Managed Openshift 4.3 (ROKS)\n---\n\nimport Globals from 'gatsby-theme-carbon/src/templates/Globals';\n\n<PageDescription>\n\n</PageDescription>\n\n## Install Cloud Pak for Data 3.0.1 on IBM Managed Openshift 4.3 (ROKS)\n\n### Sizing Openshift Cluster for Cloud Pak for Data 3.0.1\n\nSizing Worker Nodes based on Services that are to be installed. Refer : https://salesconfig.ibmcloudpack.com/sales/#/zen/configure\nTo do the sizing\n\nPlease note that if you want to install Watson AI services (Watson Assistant, Watson Discovery, Watson AIOps, Watson Language Translator, Watson Speech to Text, Watson Text to Speech) size them separately as they will need bare metal worker nodes and will not work on virtual server worker nodes.\n\n### Provision Openshift 4.3 Cluster on IBM Cloud\n\n**Note:** Make sure you have Administrator and Manager lever permission on the account where you are provisioning the cluster.\n\nProvision Openshift 4.3 Cluster from IBM Cloud console. Select Virtual Server Worker nodes based on the above sizing calculations. If you are installing Watson AI services, we will add Bare metal worker nodes post the cluster creation.\n\nOnce the cluster is created, create a new worker pool which will have bare metal servers required for Watson AI Services installation.\n\n\n\nOnce the cluster is ready, launch its console and on the right top corner, from copy login command, get the token to login to Openshift cluster remotely using cli\n \n\nMake sure you have a system with Openshift and IBM Cloud cli installed.\nhttps://cloud.ibm.com/docs/openshift?topic=openshift-openshift-cli#cli_oc\nhttps://cloud.ibm.com/docs/cli/reference/bluemix_cli/download_cli.html\n\nExecute oc login command obtained in above step from Openshift Web Console\n\n### Setting up Openshift Cluster for Cloud Pak for Data Installation\n\n1.\tCreate an external route of Openshift Image registry.\nUse token obtained in abive step to login from a system to OpenShift Cluster and run below commands to create an external route\n\n```\noc create route reencrypt --service=image-registry -n openshift-image-registry\noc annotate route image-registry --overwrite haproxy.router.openshift.io/balance=source -n openshift-image-registry\n```\n\n2.\tResize image registry storage volume\nDefault size of Openshift image registry will not be sufficient to load images if you are going to install multiple Services on Cloud Pak for Data. Hence it needs to be resized to 200GB. Run below commands to do it.\n\nibmcloud login (login into Account where your Openshift Cluster is setup)\n```\nregistry_pv=`oc get pvc -n openshift-image-registry | grep \"image-registry-storage\" | awk '{print $3}'`\nvolid=`oc describe pv $registry_pv -n openshift-image-registry | grep volumeId`\nIFS='='\nread -ra vol <<< \"$volid\"\nvolume=${vol[1]}\necho volume id is $volume\nibmcloud sl file volume-modify $volume --new-size 200 --new-tier 10 â€“force\n```\n\n3.\tSet kernel parameters (https://www.ibm.com/support/knowledgecenter/SSQNUZ_3.0.1/cpd/install/node-settings.html)\nSince we do not have ssh access to worker nodes on ROKS, we will use daemonset to perform kernel parameter settings. Create setkernelparameters.yaml file with below contents\n\n```apiVersion: tuned.openshift.io/v1\nkind: Tuned\nmetadata:\n  name: cp4d-wkc-ipc\n  namespace: openshift-cluster-node-tuning-operator\nspec:\n  profile:\n  - name: cp4d-wkc-ipc\n    data: |\n      [main]\n      summary=Tune IPC Kernel parameters on OpenShift Worker Nodes running WKC Pods\n      [sysctl]\n      kernel.shmall = 33554432\n      kernel.shmmax = 68719476736\n      kernel.shmmni = 16384\n      kernel.sem = 250 1024000 100 16384\n      kernel.msgmax = 65536\n      kernel.msgmnb = 65536\n      kernel.msgmni = 32768\n      vm.max_map_count = 262144\n  recommend:\n  - match:\n    - label: node-role.kubernetes.io/worker\n    priority: 10\n    profile: cp4d-wkc-ipc\n```\n\nRun below commands to do the changes\n\n```\noc project kube-system\noc create -f setkernelparameters.yaml\n```\n\n4.\tChange NFS mount settings\nIf you are using IBM Cloud File Storage for PVC creation, we need to make sure pvcs are mounted with root permissions. \n\na.\tCreate a service account called norootsquash by running the following command:\n\n```\noc create -f - << EOF\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: norootsquash\n  namespace: kube-system\nEOF\n```\n\nb.\tGive the service account privileged security context constraints (SCC) by running the following command:\n\n``` \noc adm policy add-scc-to-user privileged system:serviceaccount:kube-system:norootsquash\n```\n\nc.\tCreate the daemonset by running the following command:\n\n```\noc create -f - << EOF\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: norootsquash\n  namespace: kube-system\n  labels:\n    tier: management\n    app: norootsquash\nspec:\n  selector:\n    matchLabels:\n      name: norootsquash\n  template:\n    metadata:\n      labels:\n        name: norootsquash\n    spec:\n      serviceAccountName: norootsquash\n      initContainers:\n        - resources:\n            requests:\n              cpu: 0.1\n          securityContext:\n            privileged: true\n          image: alpine:3.6\n          name: unrootsquash\n          command: [\"chroot\", \"/host\", \"sh\", \"-c\"]\n          args:\n            - >\n              grep \"^Domain = slnfsv4.com\" /etc/idmapd.conf;\n              if [ \"\\$?\" -ne \"0\" ] ; then\n                sed -i 's/.*Domain =.*/Domain = slnfsv4.com/g' /etc/idmapd.conf;\n                nfsidmap -c;\n                rpc.idmapd\n              fi;\n          volumeMounts:\n            - name: host\n              mountPath: /host\n      containers:\n        - resources:\n            requests:\n              cpu: 0.1\n          image: alpine:3.6\n          name: sleep\n          command: [\"/bin/sh\", \"-c\"]\n          args:\n            - >\n              while true; do\n                sleep 100000;\n              done\n      volumes:\n        - hostPath:\n            path: /\n            type: Directory\n          name: host\nEOF\n```\n\n### Setting Portworx Storage\n\nWatson AI services (Watson Assistant, Watson Discovery, Watson Knowledge Studio, Watson Speech to Text and Watson text to Speech) install is currently supported only with Enterprise Portworx storage. Follow the steps mentioned below to set that up for ROKS. Make sure you are logged in to IBM Cloud and Openshift using CLI (ibmcloud and oc)\n\n \n\n","fileAbsolutePath":"/home/runner/work/ibm-enterprise-runbooks/ibm-enterprise-runbooks/src/pages/install/data/index.mdx"}}},"staticQueryHashes":["1364590287","2102389209","2102389209","227138135","227138135","2456312558","2746626797","2746626797","2982904675","3018647132","3018647132","3906363820","3906363820","768070550"]}